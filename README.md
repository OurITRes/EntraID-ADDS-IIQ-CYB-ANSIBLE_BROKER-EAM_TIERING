# Entra ID √ó SailPoint IIQ √ó AD DS (Multi-for√™ts) ‚Äî Tiering EAM (T2/T1/T0)

Ce d√©p√¥t fournit **3 diagrammes de s√©quence PlantUML** + **1 diagramme JEA** et toute la **documentation** pour op√©rer un mod√®le o√π :
- **IIQ** (Tier‚Äë1) orchestre le **provisioning T2** (users licenci√©s Entra ID), et **les acc√®s JIT** pour **T1** et **T0** via **CyberArk (PVWA/PSM)** + **JEA** ;
- Les **comptes admin** n‚Äôont **aucun standing access** ni licence ;
- **PAW T1/T0**, **PIM/CA**, **JEA**, **d√©l√©gations OU**, **scoping Entra Connect** assurent la s√©paration **EAM (T2/T1/T0)**.
#  Nouveaut√©s de la v0.1.4-beta (par rapport √† v0.1.3-beta)

## Version 0.1.4-beta
- **Defender for Cloud Apps** : contr√¥les de session pour portails admin ‚Üí `policies/defender-for-cloud-apps/`
- **Terraform** : dynamic groups + Conditional Access ‚Üí `terraform/`
- **Ansible PVWA API** : playbook `grant_t1_jit_pvwa_api.yml` (appel r√©el via `uri`) ‚Üí `playbooks/t1_admin/`
- **Runbook Break-glass T0** ‚Üí `runbooks/RUNBOOK_BREAKGLASS_T0.md`
- **Grafana KPIs** ‚Üí `observability/grafana/dashboard_kpis.json`

## üß© Defender for Cloud Apps (Session Control)

**Fichier :**
`policies/defender-for-cloud-apps/MDA-Admin-Portals-Restrict-Downloads.json`

**Description :**
- Restreint les **t√©l√©chargements** sur les portails administratifs (Azure, Entra, M365).  
- Implique le **monitoring** et le **watermarking** des sessions sensibles.  
- Ciblage pr√©cis via **groupe dynamique** des administrateurs.  
- Objectif : √©viter toute fuite de donn√©es depuis les consoles d‚Äôadministration.

## üß± Terraform (Infrastructure as Code ‚Äì exemples)

**R√©pertoire :** `terraform/`

### Contenu :

- **`providers.tf`**  
  D√©clare les providers :
  - `azuread`
  - `microsoft365`

- **`dynamic_groups.tf`**  
  D√©finit un **groupe dynamique T1/PRD** bas√© sur les attributs :
  - `extensionAttribute10`
  - `extensionAttribute11`

- **`conditional_access.tf`**  
  Exemple de politique de **Conditional Access** :
  - ‚ÄúPIM activation PAW-only‚Äù  
  - Restreint les activations PIM aux **Postes d‚ÄôAdministration S√©curis√©s (PAW)** uniquement.

- **`outputs.tf`**  
  Exporte les **IDs utiles** (groupes, policies, objets).

üí° *Ces fichiers sont √† adapter selon la configuration des providers de Conditional Access (les capacit√©s √©voluent rapidement).*


## ‚öôÔ∏è Ansible (API PVWA ‚Äì int√©gration r√©elle)

**Fichier :**
`playbooks/t1_admin/grant_t1_jit_pvwa_api.yml`

**Fonction :**
- Effectue un **appel HTTP** (module `uri`) vers :
/PasswordVault/API/Accounts/<id>/Requests

markdown
Copy code
- Variables d‚Äôenvironnement :
- `PVWA_BASE_URL`
- `PVWA_TOKEN`
- Permet une **demande d‚Äôacc√®s JIT (Just-In-Time)** via API pour les comptes T1, int√©gr√©e au mod√®le de r√¥les CyberArk.


## üö® Runbook Incident (Break-Glass T0)

**Fichier :**
`runbooks/RUNBOOK_BREAKGLASS_T0.md`

**Objectif :**
- Proc√©dure **critique P1** pour gestion d‚Äôincident majeur sur Tier 0.  
- √âtapes cl√©s :
1. Acc√®s via **HSM/coffre-fort** s√©curis√©.  
2. Signature **2-of-3** (approbation multi-personnes).  
3. Utilisation d‚Äôun **bastion restreint**.  
4. Cr√©ation d‚Äôun **compte d‚Äôurgence temporaire**.  
5. Journalisation en **WORM** (Write-Once-Read-Many).  
6. **Post-mortem** obligatoire apr√®s r√©solution.


## üìä Grafana Dashboard (KPIs S√©curit√© & Gouvernance)

**Fichier :**
`observability/grafana/dashboard_kpis.json`

**Indicateurs cl√©s :**
- % d‚Äôadministrateurs **sans acc√®s permanent (standing access)**  
- **Temps moyen d‚Äôapprobation** des demandes PIM/PVWA  
- Nombre de **sessions PSM** par jour  
- **Licences √©vit√©es** gr√¢ce aux acc√®s temporaires et √† l‚Äôautomatisation

üéØ *Objectif : fournir une visibilit√© consolid√©e sur la posture Zero Standing Privilege (ZSP) et la gouvernance des acc√®s √† privil√®ges.*

---

## Version 0.1.3-beta

# Nouveaut√©s de la v0.1.3-beta (par rapport √† v0.1.2-beta)

- Entra ID ‚Äî Groupes dynamiques (exemples JSON) integration/entra-dynamic-groups/
  - dynamic_group_T1_PRD.json : r√®gle (user.extensionAttribute10 -eq "T1") and (user.extensionAttribute11 -eq "PRD")
  - dynamic_group_Admin_ANY.json : r√®gle (user.extensionAttribute12 -eq "Admin")
- Conditional Access ‚Äî Politiques exemples (JSON) policies/conditional-access/
  - CA-PIM-Activation-PAW-Only.json : MFA + device compliant + PAW-only pour activer PIM
  - CA-Admin-Block-Non-PAW.json : block tout acc√®s admin hors PAW
- Observabilit√© ‚Äî Dashboard Splunk (corr√©lation e2e) observability/splunk/dashboard_identity_jit.xml.json
  - Panneaux : IIQ Requests, PVWA Sessions, AD Changes via JEA, Entra ID Updates (Graph)
  - Requ√™tes type stats pr√™tes √† adapter √† tes index/sourcetypes

---

## üÜï Version 0.1.2-beta

## üìÅ Structure
```
ROOT/
‚îú‚îÄ diagrams/                                # (V2)
‚îÇ  ‚îú‚îÄ tier2_provisioning.puml               # T2 standard (licenci√© Entra ID)
‚îÇ  ‚îú‚îÄ tier1_admin_access.puml               # T1 JIT via PAW T1 + PVWA/PSM + JEA-T1
‚îÇ  ‚îú‚îÄ tier0_admin_access.puml               # T0 JIT via PAW T0 + double appro + JEA-T0
‚îÇ  ‚îî‚îÄ jea_mechanics.puml                    # M√©canique JEA
‚îú‚îÄ jea/                                     # (V2)
‚îÇ  ‚îú‚îÄ T1/RoleCapabilities/JEA.AD.T1.psrc
‚îÇ  ‚îú‚îÄ T1/SessionConfigurations/JEA.AD.T1.pssc
‚îÇ  ‚îú‚îÄ T0/RoleCapabilities/JEA.AD.T0.psrc
‚îÇ  ‚îî‚îÄ T0/SessionConfigurations/JEA.AD.T0.pssc
‚îú‚îÄ playbooks/                               # (V2) Ansible par tier
‚îÇ  ‚îú‚îÄ t2_standard/provision_t2.yml
‚îÇ  ‚îú‚îÄ t1_admin/grant_t1_jit.yml
‚îÇ  ‚îî‚îÄ t0_admin/grant_t0_jit.yml
‚îú‚îÄ scripts/ps/                              # (V2) Helpers PowerShell
‚îÇ  ‚îú‚îÄ Invoke-ADUserProvision.ps1
‚îÇ  ‚îú‚îÄ JEA-T1-AdminTasks.ps1
‚îÇ  ‚îî‚îÄ JEA-T0-AdminTasks.ps1
‚îú‚îÄ inventory/                               # (V2) INI d‚Äôexemples
‚îÇ  ‚îú‚îÄ t2.ini
‚îÇ  ‚îú‚îÄ t1.ini
‚îÇ  ‚îî‚îÄ t0.ini
‚îú‚îÄ integration/
‚îÇ  ‚îî‚îÄ entra-extension-attributes/
‚îÇ     ‚îú‚îÄ scim_payload_example.json          # Exemple SCIM IIQ ‚Üí Entra
‚îÇ     ‚îú‚îÄ graph_update_example.ps1           # PowerShell Graph SDK (PATCH ext attrs)
‚îÇ     ‚îú‚îÄ graph_update_example.yml           # Workflow GitHub Actions (Graph via az rest)
‚îÇ     ‚îú‚îÄ iiq_scim_mapping.csv               # Mapping IIQ ‚Üí extensionAttributes
‚îÇ     ‚îú‚îÄ app_registration_min.json          # App reg minimal (User.ReadWrite.All)
‚îÇ     ‚îú‚îÄ PVWA.postman_collection.json       # Postman: JIT & PSM connect (placeholders)
‚îÇ     ‚îî‚îÄ README.md                          # Explications + s√©curit√© + groupes dynamiques
‚îú‚îÄ docs/                                    # Nouvelles docs par audience
‚îÇ  ‚îú‚îÄ BUSINESS.md       # valeur d‚Äôaffaires, KPIs, roadmap
‚îÇ  ‚îú‚îÄ ARCHITECTURE.md   # vues, tiers, flux privil√©gi√©s
‚îÇ  ‚îú‚îÄ IMPLEMENTATION.md # √©tapes pratiques (Connect, JEA, Orchestrateur, PVWA)
‚îÇ  ‚îú‚îÄ DEVELOPERS.md     # API Graph/SCIM, Postman, int√©grations
‚îÇ  ‚îú‚îÄ ENTRA.md          # AUs, PIM, CA, licences
‚îÇ  ‚îú‚îÄ IIQ.md            # Workflows, connecteurs, recertifications
‚îÇ  ‚îú‚îÄ CYBERARK.md       # Policies, PSM sessions, onboarding
‚îÇ  ‚îú‚îÄ SECURITY.md       # Zero Trust, no standing access, MFA, logs
‚îÇ  ‚îú‚îÄ GOVERNANCE.md     # d√©cisions, recerts, KPI/OKR, break-glass
‚îÇ  ‚îú‚îÄ GLOSSARY.md       # vocabulaire (EAM, PIM, JEA, etc.)
‚îÇ  ‚îî‚îÄ FAQ.md            # questions fr√©quentes
‚îú‚îÄ .github/workflows/
‚îÇ  ‚îú‚îÄ render-plantuml.yml                   # (V2) Rend les .puml en PNG
‚îÇ  ‚îî‚îÄ ansible-dry-run.yml                   # NEW: dry-run de playbooks T2/T1/T0
‚îú‚îÄ .env.example                             # Secrets/vars attendues (Graph, PVWA)
‚îú‚îÄ .gitignore
‚îî‚îÄ README.md                                # (V2 + rappel)
```

## Ajout de la documentation
- Business / ex√©cutifs ‚Üí docs/BUSINESS.md (valeur d‚Äôaffaires, KPI, roadmap).
- Architectes ‚Üí docs/ARCHITECTURE.md, diagrams/*.puml.
- Ops / Impl√©mentation ‚Üí docs/IMPLEMENTATION.md, playbooks/*, jea/*.
- Dev / Int√©grations ‚Üí docs/DEVELOPERS.md, integration/*, Postman, Graph/SCIM.
- Entra ID ‚Üí docs/ENTRA.md (AUs, PIM, CA, licences).
- IIQ ‚Üí docs/IIQ.md (workflows, connecteurs, recerts).
- CyberArk ‚Üí docs/CYBERARK.md (policies, PSM, onboarding, JIT).
- S√©curit√© & Gouvernance ‚Üí docs/SECURITY.md, docs/GOVERNANCE.md.
- Tout le monde ‚Üí docs/GLOSSARY.md, docs/FAQ.md.

## Conseils de prod
- **Graph App Reg** : scope minimal (User.ReadWrite.All), secret court, rotation, pas de Global Admin.
- **CI/CD** : garde les workflows ‚Äúdry-run‚Äù tant que le bastion/JEA/PVWA de prod n‚Äôest pas raccord√©.

---

## üÜï Version 0.1.1-beta ‚Äî Ajouts majeurs (s√©par√©s par T2 / T1 / T0 / standard)

## üìÅ Structure
```
ROOT/
‚îú‚îÄ diagrams/
‚îÇ  ‚îú‚îÄ tier2_provisioning.puml
‚îÇ  ‚îú‚îÄ tier1_admin_access.puml
‚îÇ  ‚îú‚îÄ tier0_admin_access.puml
‚îÇ  ‚îî‚îÄ jea_mechanics.puml
‚îú‚îÄ jea/
‚îÇ  ‚îú‚îÄ T1/
‚îÇ  ‚îÇ  ‚îú‚îÄ RoleCapabilities/JEA.AD.T1.psrc
‚îÇ  ‚îÇ  ‚îî‚îÄ SessionConfigurations/JEA.AD.T1.pssc
‚îÇ  ‚îî‚îÄ T0/
‚îÇ     ‚îú‚îÄ RoleCapabilities/JEA.AD.T0.psrc
‚îÇ     ‚îî‚îÄ SessionConfigurations/JEA.AD.T0.pssc
‚îú‚îÄ playbooks/
‚îÇ  ‚îú‚îÄ t2_standard/provision_t2.yml
‚îÇ  ‚îú‚îÄ t1_admin/grant_t1_jit.yml
‚îÇ  ‚îî‚îÄ t0_admin/grant_t0_jit.yml
‚îú‚îÄ scripts/ps/
‚îÇ  ‚îú‚îÄ Invoke-ADUserProvision.ps1
‚îÇ  ‚îú‚îÄ JEA-T1-AdminTasks.ps1
‚îÇ  ‚îî‚îÄ JEA-T0-AdminTasks.ps1
‚îú‚îÄ inventory/
‚îÇ  ‚îú‚îÄ t2.ini
‚îÇ  ‚îú‚îÄ t1.ini
‚îÇ  ‚îî‚îÄ t0.ini
‚îú‚îÄ docs/
‚îÇ  ‚îî‚îÄ CyberArk-PVWA-API.md
‚îú‚îÄ .github/workflows/
‚îÇ  ‚îî‚îÄ render-plantuml.yml
‚îú‚îÄ .gitignore
‚îî‚îÄ README.md
```

### ‚úÖ JEA (Just Enough Administration)
- `jea/T1/RoleCapabilities/JEA.AD.T1.psrc` & `jea/T1/SessionConfigurations/JEA.AD.T1.pssc`
- `jea/T0/RoleCapabilities/JEA.AD.T0.psrc` & `jea/T0/SessionConfigurations/JEA.AD.T0.pssc`  
> **√Ä faire c√¥t√© bastion** : copier les `.psrc` dans `C:\ProgramData\JEA\RoleCapabilities\`, les `.pssc` o√π souhait√©, puis :
```powershell
Register-PSSessionConfiguration -Name JEA-AD-T1 -Path C:\Path\To\JEA.AD.T1.pssc -Force
Register-PSSessionConfiguration -Name JEA-AD-T0 -Path C:\Path\To\JEA.AD.T0.pssc -Force
```
Les transcripts sont dans `C:\JEA\Transcripts\T1|T0` (√† exp√©dier vers SIEM).

### ‚úÖ Ansible ‚Äî Playbooks par **tier**
- `playbooks/t2_standard/provision_t2.yml`
- `playbooks/t1_admin/grant_t1_jit.yml`
- `playbooks/t0_admin/grant_t0_jit.yml`

### ‚úÖ Inventaires
- `inventory/t2.ini`, `inventory/t1.ini`, `inventory/t0.ini`

### ‚úÖ Scripts PowerShell
- `scripts/ps/Invoke-ADUserProvision.ps1` (T2 provisioning helper)
- `scripts/ps/JEA-T1-AdminTasks.ps1` (exemple de commande sous JEA-T1)
- `scripts/ps/JEA-T0-AdminTasks.ps1` (exemple de commande sous JEA-T0)

### ‚úÖ Docs
- `docs/CyberArk-PVWA-API.md` (endpoints cl√©s & conseils)

---

## üö¶ Bonnes pratiques d‚Äôusage
- **Ne pas** √©largir les cmdlets visibles dans les `.psrc` sans revue S√©cu.
- Toujours ex√©cuter **T0** via **PSM + JEA-T0**, **double approbation** c√¥t√© PVWA.
- Les playbooks T1/T0 contiennent des **placeholders** pour l‚ÄôAPI PVWA : branchez vos appels `uri`/SDK selon votre config.
- Entra Connect reste scopp√© : **1 for√™t autoritaire** pour l‚Äôobjet cloud licenci√© (T2 uniquement).

---

## üÜï Version 0.1.0-beta

## üìÅ Structure
```
.
‚îú‚îÄ diagrams/
‚îÇ  ‚îú‚îÄ tier2_provisioning.puml       # IIQ provisionne comptes T2 + licence Entra ID
‚îÇ  ‚îú‚îÄ tier1_admin_access.puml       # IIQ demande acc√®s T1 JIT (PAW T1)
‚îÇ  ‚îú‚îÄ tier0_admin_access.puml       # IIQ demande acc√®s T0 JIT (PAW T0, double approbation)
‚îÇ  ‚îî‚îÄ jea_mechanics.puml            # M√©canique JEA (role capability + session config)
‚îî‚îÄ .github/workflows/
   ‚îî‚îÄ render-plantuml.yml           # CI pour rendre PNG √† partir des .puml
```

## üß© Hypoth√®ses cl√©s
- **Seuls les comptes T2 (users)** sont **licenci√©s Entra ID** (1 licence/personne).
- Les **comptes admin** (`a-<user>`, `a-<user0>`) sont **non licenci√©s** et **sans standing access** ; acc√®s **JIT** via **PVWA/PSM** & **JEA**.
- **IIQ reste Tier‚Äë1** : pas d‚Äôactions directes T0 ; toutes les op√©rations T0 passent par **PSM + JEA**.
- **Entra Connect** : **une seule for√™t ‚Äúsource autoritaire‚Äù** pour l‚Äôobjet cloud licenci√© (PRD), filtrage OU/attributs pour DEV/TST/Admin.

## üõ°Ô∏è Checklist de mise en ≈ìuvre (r√©sum√©)
### Gouvernance & Identit√©
- IIQ = source of truth (mapping identit√© ‚Üî comptes T2 & admin).
- Strat√©gie 1 licence/personne (T2 seulement).
- Admin sans standing access ; naming & tags `extensionAttribute*` (tier/env/type).

### Synchronisation & Cloud
- Entra Connect/Cloud Sync : 1 for√™t autoritaire, filtres d‚Äôexclusion pour admin/DEV/TST, `mS-DS-ConsistencyGuid` ‚Üí `ImmutableID`.
- SCIM/Graph pour `extensionAttributes` et m√©tadonn√©es.

### Orchestration (CI/CD)
- Runner GitHub Actions **Tier‚Äë1**, **Ansible** playbooks (T2/T1/T0) idempotents.
- Z√©ro secret en clair : **PVWA JIT tickets**, rotation post‚Äëop.

### CyberArk
- PVWA : SSO (MFA), approbations ; PSM/PSMP : brokering + session recording.
- JIT group membership (si utilis√©) : ajout/retrait auto.
- Politiques T0 : **double approbation**, fen√™tre courte, justification.

### AD DS
- D√©l√©gations OU pour T2 (droits pr√©cis, pas DA).
- OU Admin T0 : AdminSDHolder, FGPP admin, Kerberos AES‚Äëonly.
- Groupes T1/T0 d√©di√©s (pas DA direct), vides par d√©faut.
- ‚ÄúNo standing access‚Äù : op√©rations via JEA/PSM/JIT seulement.

### JEA
- Role Capability `.psrc` (cmdlets whitelisteÃÅes) ; Session Config `.pssc` (mapping groupes ‚Üí r√¥les).
- Endpoints s√©par√©s `JEA-AD-T1` / `JEA-AD-T0`, transcriptions sign√©es, logs vers SIEM.

### PAW & CA/PIM
- PAW T1/T0 g√©r√©s (Intune), r√©seau segment√© ; acc√®s sensibles **PAW‚Äëonly** via **Conditional Access**.
- PIM en ‚Äúeligible only‚Äù, MFA, approbations, dur√©e 30‚Äì120 min (T0 ‚â§ 60).

### Journalisation & DR
- PSM recording + PowerShell transcription + ETW/Sysmon ‚Üí SIEM.
- Runbooks standard, break‚Äëglass T0, sauvegardes configs IIQ/PVWA/JEA.

> Voir les 3 s√©quences `.puml` pour le d√©tail des flux et `jea_mechanics.puml` pour la m√©canique JEA.

## üöÄ CI : rendu automatique des diagrammes
Le workflow suivant rend les `.puml` en **PNG** √† chaque `push` :
- Utilise l‚Äôaction `TimonVS/plantuml-action` (sans secrets).
- √âcrit les PNG **dans le m√™me dossier `diagrams/`**.

## üß™ Tests et validations
- Valider les playbooks Ansible en dry‚Äërun (`--check`).
- Tester un flux bout‚Äëen‚Äëbout **T2**, puis **T1 (JIT)**, puis **T0 (JIT + double appr.)**.
- V√©rifier que **aucune** appartenance permanente n‚Äôest laiss√©e apr√®s expiration.

---

¬© 2025 ‚Äî Architecture de r√©f√©rence Entra ID √ó IIQ √ó AD DS (EAM T2/T1/T0).


---